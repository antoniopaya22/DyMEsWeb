---
import Layout from './Layout.astro';
import SettingsPanel from '../components/react/SettingsPanel';

export interface Props {
  title?: string;
}

const { title = 'DyMEs' } = Astro.props;
---

<Layout title={title}>
  <!-- Skip to content (Style Guide §12.4) -->
  <a href="#main-content" class="sr-only focus:not-sr-only focus:fixed focus:top-4 focus:left-4 focus:z-[200] focus:px-4 focus:py-2 focus:rounded-xl focus:text-white focus:bg-[#8f3d38] focus:text-sm focus:font-semibold">Saltar al contenido</a>

  <!-- Auth loading screen -->
  <div id="auth-loading" class="fixed inset-0 z-[100] flex items-center justify-center" role="status" aria-live="polite" aria-label="Verificando sesión" style="background:var(--app-loading-bg)">
    <div class="text-center animate-fade-in">
      <div class="relative inline-block mb-6">
        <div class="absolute -inset-4 rounded-full opacity-40 animate-pulse" style="background:radial-gradient(circle,rgba(143,61,56,.35),transparent 70%)"></div>
        <img src="/favicon.svg" alt="DyMEs" class="relative w-14 h-14" />
      </div>
      <p class="text-[13px] app-text-faint tracking-wider uppercase">Verificando sesión</p>
      <div class="mt-4 w-32 h-0.5 mx-auto rounded-full overflow-hidden" style="background:var(--app-loading-bar-track)">
        <div class="h-full w-1/2 rounded-full bg-gradient-to-r from-[#8f3d38] to-[#8f3d38]/40 animate-loading-bar"></div>
      </div>
    </div>
  </div>

  <div id="app-shell" class="flex flex-col h-screen overflow-hidden" style="display:none;">
    <!-- ═══ Topbar ═══ -->
    <header class="flex items-center justify-between px-4 sm:px-6 lg:px-8 h-14 flex-shrink-0 relative z-20"
            style="background:var(--app-header-bg);backdrop-filter:blur(16px) saturate(180%);box-shadow:0 1px 8px rgba(0,0,0,0.25)">
      <div class="absolute bottom-0 inset-x-0 h-px" style="background:linear-gradient(to right, transparent, rgba(255,255,255,0.08), transparent)"></div>

      <!-- Left: Logo -->
      <a href="/app" class="flex items-center gap-2.5 group shrink-0">
        <div class="relative">
          <div class="absolute -inset-1.5 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity duration-500" style="background:radial-gradient(circle,rgba(143,61,56,.15),transparent)"></div>
          <img src="/favicon.svg" alt="DyMEs" class="relative w-8 h-8 transition-transform duration-300 group-hover:scale-105" />
        </div>
        <div class="hidden sm:block">
          <span class="text-[15px] font-display font-bold text-white tracking-wide">DyMEs</span>
          <span class="block text-[8px] text-white/50 tracking-[0.2em] uppercase -mt-0.5">D&D 5e · SRD 5.1</span>
        </div>
      </a>

      <!-- Center: Search trigger -->
      <button id="topbar-search-btn" class="hidden sm:flex items-center gap-2.5 px-4 py-1.5 rounded-xl transition-all duration-200 group mx-4 max-w-md flex-1"
              type="button"
              style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08)">
        <svg class="w-3.5 h-3.5 text-white/50 transition-colors shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <span class="text-[12px] text-white/50 transition-colors flex-1 text-left">Buscar...</span>
        <kbd class="text-[9px] font-mono px-1.5 py-0.5 rounded-md shrink-0" style="color:rgba(255,255,255,0.4);background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08)">⌘K</kbd>
      </button>

      <!-- Right: Actions -->
      <div class="flex items-center gap-1.5">
        <!-- Mobile search -->
        <button id="mobile-search-btn" class="sm:hidden p-2 rounded-lg transition-colors hover:bg-white/10" aria-label="Buscar" type="button">
          <svg class="w-5 h-5 text-white/70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        </button>

        <!-- Compendio público -->
        <a href="/compendio" target="_blank" rel="noopener noreferrer"
           class="hidden sm:flex p-2 rounded-lg transition-colors hover:bg-white/10" aria-label="Compendio SRD público" title="Compendio público">
          <svg class="w-5 h-5 text-white/70" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M12 7v14"/><path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"/>
          </svg>
        </a>

        <!-- Settings -->
        <button type="button" class="p-2 rounded-lg transition-colors hover:bg-white/10" aria-label="Ajustes" id="topbar-settings-btn">
          <svg class="w-5 h-5 text-white/70" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
        </button>

        <!-- Account avatar -->
        <a href="/app/account" class="p-1 rounded-lg transition-colors hover:bg-white/10" aria-label="Mi cuenta">
          <div class="w-8 h-8 rounded-lg flex items-center justify-center text-[11px] font-bold text-white" id="topbar-avatar"
               style="background:linear-gradient(135deg,#8f3d38,#6b2e2a);box-shadow:0 2px 6px rgba(143,61,56,0.25)">?</div>
        </a>
      </div>
    </header>

    <!-- ═══ Main area ═══ -->
    <div class="flex-1 overflow-hidden" style="background:var(--app-bg)">
      <main class="h-full overflow-y-auto" id="main-content" style="background:var(--app-main-gradient)">
        <!-- Subtle top ambient glow -->
        <div class="pointer-events-none absolute top-14 left-1/2 -translate-x-1/2 w-[600px] h-[300px] opacity-[0.025]" style="background:radial-gradient(ellipse, #8f3d38, transparent 70%)"></div>
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-10 py-6 sm:py-8 lg:py-10 relative">
          <slot />
        </div>
      </main>
    </div>
  </div>

  <!-- ═══ Settings Modal (React island) ═══ -->
  <SettingsPanel client:load />

  <!-- ═══ Command Palette (Ctrl+K / ⌘K) ═══ -->
  <div id="cmd-palette" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true" aria-label="Paleta de comandos">
    <div class="absolute inset-0" style="background:var(--app-overlay-bg);backdrop-filter:blur(6px)" id="cmd-palette-backdrop"></div>
    <div class="relative max-w-lg w-full mx-auto mt-[15vh] rounded-2xl overflow-hidden animate-slide-up-sm"
         style="background:var(--app-cmd-bg);border:1px solid var(--app-cmd-border);box-shadow:var(--app-cmd-shadow)">
      <div class="flex items-center gap-3 px-5 py-4" style="border-bottom:1px solid var(--app-border-subtle)">
        <svg class="w-5 h-5 app-text-faint shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <input id="cmd-input" type="text" placeholder="Buscar páginas, acciones..." class="flex-1 bg-transparent outline-none text-[15px] app-text" autocomplete="off" role="combobox" aria-expanded="true" aria-controls="cmd-results" aria-autocomplete="list" aria-activedescendant="" />
        <kbd class="text-[10px] font-mono px-2 py-0.5 rounded-md flex-shrink-0" aria-hidden="true" style="color:var(--app-text-faint);opacity:0.6;background:var(--app-kbd-bg);border:1px solid var(--app-kbd-border)">Esc</kbd>
      </div>
      <div id="cmd-results" class="max-h-[350px] overflow-y-auto py-2 px-2" role="listbox" aria-label="Resultados de búsqueda">
        <div class="text-center py-8">
          <span class="text-[13px] app-text-faint">Escribe para buscar...</span>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  /* ─── Topbar active icon ─── */
  .topbar-icon-active svg {
    color: #ffffff;
  }

  /* ─── Command Palette Items ─── */
  .cmd-item {
    @apply flex items-center gap-3 px-3 py-2.5 rounded-xl cursor-pointer transition-all duration-150;
    color: var(--app-text-muted);
  }
  .cmd-item:hover, .cmd-item.focused {
    background: var(--app-hover-bg);
    color: var(--app-text);
  }
  .cmd-item-icon {
    @apply w-8 h-8 rounded-lg flex items-center justify-center text-base shrink-0;
    background: var(--app-hover-bg);
    border: 1px solid var(--app-border-subtle);
  }
  .cmd-item-label { font-size: 13px; font-weight: 500; }
  .cmd-item-desc { font-size: 11px; color: var(--app-text-faint); }
  .cmd-group-label {
    font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em;
    color: var(--app-text-faint); padding: 8px 12px 4px;
  }
  #cmd-input::placeholder { color: var(--app-text-faint); }

  /* ─── Scrollbar ─── */
  .scrollbar-thin::-webkit-scrollbar { width: 4px; }
  .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
  .scrollbar-thin::-webkit-scrollbar-thumb { background: var(--app-border); border-radius: 2px; }
  .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: var(--app-divider); }

  @keyframes loading-bar {
    0% { transform: translateX(-100%); }
    50% { transform: translateX(100%); }
    100% { transform: translateX(100%); }
  }
  .animate-loading-bar { animation: loading-bar 1.5s ease-in-out infinite; }
</style>

<script>
  import { supabase } from '../lib/supabase';

  // ─── Auth Guard ───
  async function checkAuth() {
    const authLoading = document.getElementById('auth-loading');
    const appShell = document.getElementById('app-shell');

    try {
      const hash = window.location.hash;
      if (hash && (hash.includes('access_token') || hash.includes('refresh_token'))) {
        await new Promise<void>((resolve, reject) => {
          const timeout = setTimeout(() => reject(new Error('OAuth callback timeout')), 10000);
          const { data: { subscription } } = supabase.auth.onAuthStateChange((event) => {
            if (event === 'SIGNED_IN') {
              clearTimeout(timeout);
              subscription.unsubscribe();
              history.replaceState(null, '', window.location.pathname);
              resolve();
            }
          });
        });
      }

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { window.location.href = '/login'; return; }

      const userName = session.user.user_metadata?.nombre || session.user.email?.split('@')[0] || 'Aventurero';
      const initial = userName[0]?.toUpperCase() || '?';

      // Set avatar in topbar
      const avatarEl = document.getElementById('topbar-avatar');
      if (avatarEl) avatarEl.textContent = initial;

      if (authLoading) authLoading.style.display = 'none';
      if (appShell) appShell.style.display = 'flex';
    } catch (err) {
      console.error('[Auth Guard] Error:', err);
      window.location.href = '/login';
    }
  }
  checkAuth();

  // ─── Highlight active topbar icon ───
  // (no longer needed for settings — it's a modal now)

  // ─── Settings modal trigger ───
  document.getElementById('topbar-settings-btn')?.addEventListener('click', () => {
    window.dispatchEvent(new CustomEvent('open-settings'));
  });

  // ─── Command Palette ───
  const CMD_ITEMS = [
    { icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>', label: 'Personajes', desc: 'Ver tus personajes', url: '/app', group: 'Navegar' },
    { icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>', label: 'Ajustes', desc: 'Configuración', action: 'open-settings', group: 'Navegar' },
    { icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>', label: 'Mi cuenta', desc: 'Perfil y sesión', url: '/app/account', group: 'Navegar' },
    { icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>', label: 'Nuevo personaje', desc: 'Crear un personaje', url: '/app/characters/create', group: 'Acciones' },
    { icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>', label: 'Compendio público', desc: 'Abrir en nueva pestaña', url: '/compendio', group: 'Acciones' },
  ];

  const palette = document.getElementById('cmd-palette');
  const cmdInput = document.getElementById('cmd-input') as HTMLInputElement;
  const cmdResults = document.getElementById('cmd-results');
  const cmdBackdrop = document.getElementById('cmd-palette-backdrop');
  let focusIdx = -1;

  function openPalette() {
    palette?.classList.remove('hidden');
    cmdInput?.focus();
    cmdInput.value = '';
    renderResults('');
    document.body.style.overflow = 'hidden';
  }
  function closePalette() {
    palette?.classList.add('hidden');
    document.body.style.overflow = '';
    focusIdx = -1;
  }
  function renderResults(query: string) {
    if (!cmdResults) return;
    const q = query.toLowerCase().trim();
    const filtered = q ? CMD_ITEMS.filter(i => i.label.toLowerCase().includes(q) || i.desc.toLowerCase().includes(q)) : CMD_ITEMS;

    if (filtered.length === 0) {
      cmdResults.innerHTML = '<div class="text-center py-8"><span class="text-[13px] app-text-faint">Sin resultados</span></div>';
      return;
    }
    let html = '';
    let lastGroup = '';
    filtered.forEach((item, i) => {
      if (item.group !== lastGroup) {
        html += `<div class="cmd-group-label">${item.group}</div>`;
        lastGroup = item.group;
      }
      html += `<a href="${item.url}" class="cmd-item" id="cmd-item-${i}" role="option" data-idx="${i}"${item.url === '/compendio' ? ' target="_blank"' : ''}>
        <span class="cmd-item-icon" aria-hidden="true">${item.icon}</span>
        <div><div class="cmd-item-label">${item.label}</div><div class="cmd-item-desc">${item.desc}</div></div>
      </a>`;
    });
    cmdResults.innerHTML = html;
    focusIdx = -1;
    cmdInput?.setAttribute('aria-activedescendant', '');
  }

  // Event listeners
  document.getElementById('topbar-search-btn')?.addEventListener('click', openPalette);
  document.getElementById('mobile-search-btn')?.addEventListener('click', openPalette);
  cmdBackdrop?.addEventListener('click', closePalette);
  cmdInput?.addEventListener('input', () => renderResults(cmdInput.value));

  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); openPalette(); }
    if (e.key === 'Escape') { closePalette(); }
    // Arrow navigation in palette
    if (!palette?.classList.contains('hidden')) {
      const items = cmdResults?.querySelectorAll('.cmd-item') ?? [];
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        focusIdx = Math.min(focusIdx + 1, items.length - 1);
        items.forEach((el, i) => el.classList.toggle('focused', i === focusIdx));
        cmdInput?.setAttribute('aria-activedescendant', `cmd-item-${focusIdx}`);
      }
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        focusIdx = Math.max(focusIdx - 1, 0);
        items.forEach((el, i) => el.classList.toggle('focused', i === focusIdx));
        cmdInput?.setAttribute('aria-activedescendant', `cmd-item-${focusIdx}`);
      }
      if (e.key === 'Enter' && focusIdx >= 0) { (items[focusIdx] as HTMLAnchorElement)?.click(); }
    }
  });
</script>
