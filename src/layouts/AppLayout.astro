---
import Layout from './Layout.astro';

export interface Props {
  title?: string;
}

const { title = 'DyMEs' } = Astro.props;
---

<Layout title={title}>
  <!-- Auth loading screen -->
  <div id="auth-loading" class="fixed inset-0 z-[100] flex items-center justify-center" style="background:var(--app-loading-bg)">
    <div class="text-center animate-fade-in">
      <div class="relative inline-block mb-6">
        <div class="absolute -inset-4 rounded-full opacity-40 animate-pulse" style="background:radial-gradient(circle,rgba(143,61,56,.35),transparent 70%)"></div>
        <img src="/favicon.svg" alt="DyMEs" class="relative w-14 h-14" />
      </div>
      <p class="text-[13px] app-text-faint tracking-wider uppercase">Verificando sesiÃ³n</p>
      <div class="mt-4 w-32 h-0.5 mx-auto rounded-full overflow-hidden" style="background:var(--app-loading-bar-track)">
        <div class="h-full w-1/2 rounded-full bg-gradient-to-r from-[#8f3d38] to-[#8f3d38]/40 animate-loading-bar"></div>
      </div>
    </div>
  </div>

  <div id="app-shell" class="flex h-screen overflow-hidden" style="display:none;">
    <!-- â•â•â• Sidebar (desktop: always visible, mobile: drawer) â•â•â• -->
    <div id="sidebar-backdrop" class="fixed inset-0 z-30 bg-black/50 backdrop-blur-sm hidden lg:hidden" style="transition:opacity .3s"></div>
    <aside id="sidebar" class="sidebar-drawer lg:flex lg:w-[260px] flex-col flex-shrink-0 relative z-40"
           style="background:var(--app-sidebar-bg)">
      <!-- Right border glow -->
      <div class="absolute top-0 right-0 bottom-0 w-px" style="background:linear-gradient(to bottom, transparent, var(--app-sidebar-border), transparent)"></div>
      <!-- Top atmospheric glow -->
      <div class="absolute top-0 left-0 right-0 h-48 pointer-events-none" style="background:radial-gradient(ellipse 80% 100% at 50% 0%,rgba(143,61,56,.05),transparent)"></div>

      <!-- Logo + Search -->
      <div class="px-5 pt-5 pb-4 relative">
        <a href="/app" class="flex items-center gap-3 group">
          <div class="relative">
            <div class="absolute -inset-1.5 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity duration-500" style="background:radial-gradient(circle,rgba(143,61,56,.15),transparent)"></div>
            <img src="/favicon.svg" alt="DyMEs" class="relative w-9 h-9 transition-transform duration-300 group-hover:scale-105" />
          </div>
          <div>
            <span class="text-[15px] font-display font-bold app-text tracking-wide">DyMEs</span>
            <span class="block text-[9px] app-text-faint tracking-[0.2em] uppercase mt-0.5">D&D 5e Â· SRD 5.1</span>
          </div>
        </a>
      </div>

      <!-- Sidebar search trigger -->
      <div class="px-4 mb-4">
        <button id="sidebar-search-btn" class="w-full flex items-center gap-2.5 px-3 py-2 rounded-xl text-left transition-all duration-200 group" type="button"
          style="background:var(--app-sidebar-search-bg);border:1px solid var(--app-sidebar-search-border)">
          <svg class="w-3.5 h-3.5 app-text-faint transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          <span class="text-[12px] app-text-faint transition-colors flex-1">Buscar...</span>
          <kbd class="text-[9px] font-mono px-1.5 py-0.5 rounded-md" style="color:var(--app-text-faint);opacity:0.6;background:var(--app-kbd-bg);border:1px solid var(--app-kbd-border)">âŒ˜K</kbd>
        </button>
      </div>

      <!-- Divider -->
      <div class="mx-5 h-px" style="background:linear-gradient(to right, transparent, var(--app-sidebar-border), transparent)"></div>

      <!-- Navigation -->
      <nav class="flex-1 px-3 pt-4 pb-3 space-y-0.5 overflow-y-auto scrollbar-thin">
        <span class="block px-3 pb-2 text-[9px] font-semibold uppercase tracking-[0.2em]" style="color:var(--app-sidebar-section-label)">Principal</span>

        <a href="/app" class="sidebar-link" data-path="/app">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          <span>Personajes</span>
        </a>
        <a href="/app/campaigns" class="sidebar-link" data-path="/app/campaigns">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20"/></svg>
          <span>CampaÃ±as</span>
        </a>
        <a href="/app/compendium" class="sidebar-link" data-path="/app/compendium">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 7v14"/><path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"/></svg>
          <span>Compendio</span>
        </a>

        <div class="pt-4 pb-2">
          <div class="mx-3 h-px" style="background:linear-gradient(to right, transparent, var(--app-sidebar-border), transparent)"></div>
        </div>
        <span class="block px-3 pb-2 text-[9px] font-semibold uppercase tracking-[0.2em]" style="color:var(--app-sidebar-section-label)">Cuenta</span>

        <a href="/app/settings" class="sidebar-link" data-path="/app/settings">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
          <span>Ajustes</span>
        </a>
        <a href="/app/account" class="sidebar-link" data-path="/app/account">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
          <span>Mi cuenta</span>
        </a>
      </nav>

      <!-- Quick links -->
      <div class="px-4 mb-3">
        <a href="/compendio" target="_blank" class="flex items-center gap-2.5 px-3 py-2 rounded-xl transition-all duration-200 group"
           style="background:var(--app-hover-bg);border:1px solid var(--app-border-subtle)">
          <svg class="w-3.5 h-3.5 app-text-faint transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          <span class="text-[11px] app-text-faint transition-colors">Compendio pÃºblico</span>
        </a>
      </div>

      <!-- User section at bottom -->
      <div class="relative px-3 pb-4 pt-1">
        <div class="mx-2 mb-3 h-px" style="background:linear-gradient(to right, transparent, var(--app-sidebar-border), transparent)"></div>
        <a href="/app/account" id="sidebar-user-info" class="flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all duration-200 group no-underline" style="background:transparent" onmouseover="this.style.background='var(--app-sidebar-link-hover-bg)'" onmouseout="this.style.background='transparent'">
          <div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-bold text-white relative overflow-hidden" id="sidebar-user-avatar-wrap"
               style="background:linear-gradient(135deg,#8f3d38,#6b2e2a);box-shadow:0 2px 8px rgba(143,61,56,0.25)">
            <span id="sidebar-user-avatar">?</span>
          </div>
          <div class="flex-1 min-w-0">
            <span class="text-[13px] app-text font-medium truncate block" id="sidebar-user-name">Cargando...</span>
            <span class="text-[10px] app-text-faint truncate block" id="sidebar-user-email"></span>
          </div>
          <div class="w-6 h-6 rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all" style="background:var(--app-hover-bg)">
            <svg class="w-3.5 h-3.5 app-text-faint" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
          </div>
        </a>
      </div>
    </aside>

    <!-- â•â•â• Main area â•â•â• -->
    <div class="flex-1 flex flex-col overflow-hidden min-w-0" style="background:var(--app-bg)">
      <!-- Mobile top header -->
      <header class="lg:hidden flex items-center justify-between px-4 h-14 flex-shrink-0 relative"
              style="background:var(--app-header-bg);backdrop-filter:blur(16px)">
        <div class="absolute bottom-0 inset-x-0 h-px" style="background:linear-gradient(to right, transparent, var(--app-sidebar-border), transparent)"></div>
        <div class="flex items-center gap-2">
          <button id="mobile-menu-btn" class="p-2 -ml-2 rounded-lg hover:bg-white/[.06] transition-colors" aria-label="Abrir menÃº" type="button">
            <svg class="w-5 h-5 app-text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
          </button>
          <a href="/app" class="flex items-center gap-2">
            <img src="/favicon.svg" alt="" class="w-7 h-7" />
            <span class="font-display font-bold app-text text-[15px] tracking-wide">DyMEs</span>
          </a>
        </div>
        <div class="flex items-center gap-2">
          <button id="mobile-search-btn" class="p-2 rounded-lg transition-colors" aria-label="Buscar" type="button" style="background:transparent" onmouseover="this.style.background='var(--app-hover-bg)'" onmouseout="this.style.background='transparent'">
            <svg class="w-5 h-5 app-text-faint" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          </button>
          <a href="/app/account" class="p-1 rounded-lg transition-colors" style="background:transparent" onmouseover="this.style.background='var(--app-hover-bg)'" onmouseout="this.style.background='transparent'">
            <div class="w-7 h-7 rounded-lg flex items-center justify-center text-[11px] font-bold text-white" id="mobile-header-avatar"
                 style="background:linear-gradient(135deg,#8f3d38,#6b2e2a)">?</div>
          </a>
        </div>
      </header>

      <!-- Main scrollable content -->
      <main class="flex-1 overflow-y-auto" id="main-content" style="background:var(--app-main-gradient)">
        <!-- Subtle top ambient glow -->
        <div class="pointer-events-none absolute top-0 left-1/2 -translate-x-1/2 w-[600px] h-[300px] opacity-[0.025]" style="background:radial-gradient(ellipse, #8f3d38, transparent 70%)"></div>
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-10 py-6 sm:py-8 lg:py-10 relative">
          <slot />
        </div>
      </main>
    </div>
  </div>

  <!-- â•â•â• Command Palette (Ctrl+K / âŒ˜K) â•â•â• -->
  <div id="cmd-palette" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0" style="background:var(--app-overlay-bg);backdrop-filter:blur(6px)" id="cmd-palette-backdrop"></div>
    <div class="relative max-w-lg w-full mx-auto mt-[15vh] rounded-2xl overflow-hidden animate-slide-up-sm"
         style="background:var(--app-cmd-bg);border:1px solid var(--app-cmd-border);box-shadow:var(--app-cmd-shadow)">
      <div class="flex items-center gap-3 px-5 py-4" style="border-bottom:1px solid var(--app-border-subtle)">
        <svg class="w-5 h-5 app-text-faint shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <input id="cmd-input" type="text" placeholder="Buscar pÃ¡ginas, acciones..." class="flex-1 bg-transparent outline-none text-[15px] app-text" autocomplete="off" />
        <kbd class="text-[10px] font-mono px-2 py-0.5 rounded-md flex-shrink-0" style="color:var(--app-text-faint);opacity:0.6;background:var(--app-kbd-bg);border:1px solid var(--app-kbd-border)">Esc</kbd>
      </div>
      <div id="cmd-results" class="max-h-[350px] overflow-y-auto py-2 px-2">
        <div class="text-center py-8">
          <span class="text-[13px] app-text-faint">Escribe para buscar...</span>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  /* â”€â”€â”€ Sidebar Links â”€â”€â”€ */
  .sidebar-link {
    @apply flex items-center gap-3 px-3 py-2.5 rounded-xl text-[13px] font-medium transition-all duration-200;
    color: var(--app-sidebar-link-color);
  }
  .sidebar-link:hover {
    background: var(--app-sidebar-link-hover-bg);
    color: var(--app-sidebar-link-hover-color);
  }
  .sidebar-link.active {
    background: linear-gradient(135deg, rgba(143,61,56,0.14), rgba(143,61,56,0.06));
    color: var(--app-text);
    box-shadow: 0 0 16px rgba(143,61,56,0.08), inset 0 1px 0 rgba(255,255,255,0.03);
    border: 1px solid rgba(143,61,56,0.15);
  }
  .sidebar-link svg {
    flex-shrink: 0; opacity: 0.6; transition: opacity 0.2s;
  }
  .sidebar-link:hover svg, .sidebar-link.active svg { opacity: 1; }

  /* â”€â”€â”€ Sidebar Drawer (mobile) â”€â”€â”€ */
  @media (max-width: 1023px) {
    .sidebar-drawer {
      position: fixed; top: 0; left: 0; bottom: 0;
      width: 280px; z-index: 40;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex; flex-direction: column;
    }
    .sidebar-drawer.open {
      transform: translateX(0);
    }
  }

  /* â”€â”€â”€ Command Palette Items â”€â”€â”€ */
  .cmd-item {
    @apply flex items-center gap-3 px-3 py-2.5 rounded-xl cursor-pointer transition-all duration-150;
    color: var(--app-text-muted);
  }
  .cmd-item:hover, .cmd-item.focused {
    background: var(--app-hover-bg);
    color: var(--app-text);
  }
  .cmd-item-icon {
    @apply w-8 h-8 rounded-lg flex items-center justify-center text-base shrink-0;
    background: var(--app-hover-bg);
    border: 1px solid var(--app-border-subtle);
  }
  .cmd-item-label { font-size: 13px; font-weight: 500; }
  .cmd-item-desc { font-size: 11px; color: var(--app-text-faint); }
  .cmd-group-label {
    font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em;
    color: var(--app-text-faint); padding: 8px 12px 4px;
  }
  #cmd-input::placeholder { color: var(--app-text-faint); }

  /* â”€â”€â”€ Scrollbar â”€â”€â”€ */
  .scrollbar-thin::-webkit-scrollbar { width: 4px; }
  .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
  .scrollbar-thin::-webkit-scrollbar-thumb { background: var(--app-border); border-radius: 2px; }
  .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: var(--app-divider); }

  @keyframes loading-bar {
    0% { transform: translateX(-100%); }
    50% { transform: translateX(100%); }
    100% { transform: translateX(100%); }
  }
  .animate-loading-bar { animation: loading-bar 1.5s ease-in-out infinite; }
</style>

<script>
  import { supabase } from '../lib/supabase';

  // â”€â”€â”€ Auth Guard â”€â”€â”€
  async function checkAuth() {
    const authLoading = document.getElementById('auth-loading');
    const appShell = document.getElementById('app-shell');

    try {
      const hash = window.location.hash;
      if (hash && (hash.includes('access_token') || hash.includes('refresh_token'))) {
        await new Promise<void>((resolve, reject) => {
          const timeout = setTimeout(() => reject(new Error('OAuth callback timeout')), 10000);
          const { data: { subscription } } = supabase.auth.onAuthStateChange((event) => {
            if (event === 'SIGNED_IN') {
              clearTimeout(timeout);
              subscription.unsubscribe();
              history.replaceState(null, '', window.location.pathname);
              resolve();
            }
          });
        });
      }

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { window.location.href = '/login'; return; }

      const userName = session.user.user_metadata?.nombre || session.user.email?.split('@')[0] || 'Aventurero';
      const userEmail = session.user.email || '';
      const initial = userName[0]?.toUpperCase() || '?';

      const set = (id: string, val: string) => { const el = document.getElementById(id); if (el) el.textContent = val; };
      set('sidebar-user-avatar', initial);
      set('sidebar-user-name', userName);
      set('sidebar-user-email', userEmail);
      set('mobile-header-avatar', initial);

      if (authLoading) authLoading.style.display = 'none';
      if (appShell) appShell.style.display = 'flex';
    } catch (err) {
      console.error('[Auth Guard] Error:', err);
      window.location.href = '/login';
    }
  }
  checkAuth();

  // â”€â”€â”€ Active Link Highlighting â”€â”€â”€
  const currentPath = window.location.pathname;
  document.querySelectorAll('.sidebar-link').forEach(link => {
    const linkPath = link.getAttribute('data-path');
    if (linkPath && (currentPath === linkPath || (linkPath !== '/app' && currentPath.startsWith(linkPath)))) {
      link.classList.add('active');
    } else if (linkPath === '/app' && currentPath === '/app') {
      link.classList.add('active');
    }
  });

  // â”€â”€â”€ Mobile Sidebar Drawer â”€â”€â”€
  const sidebarEl = document.getElementById('sidebar');
  const sidebarBackdrop = document.getElementById('sidebar-backdrop');
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');

  function toggleMobileDrawer(open?: boolean) {
    if (!sidebarEl) return;
    const isOpen = open ?? !sidebarEl.classList.contains('open');
    sidebarEl.classList.toggle('open', isOpen);
    sidebarBackdrop?.classList.toggle('hidden', !isOpen);
    document.body.style.overflow = isOpen ? 'hidden' : '';
  }

  mobileMenuBtn?.addEventListener('click', () => toggleMobileDrawer());
  sidebarBackdrop?.addEventListener('click', () => toggleMobileDrawer(false));

  // Close drawer when clicking a nav link (mobile)
  sidebarEl?.querySelectorAll('a').forEach(a => {
    a.addEventListener('click', () => {
      if (window.innerWidth < 1024) toggleMobileDrawer(false);
    });
  });

  // â”€â”€â”€ Command Palette â”€â”€â”€
  const CMD_ITEMS = [
    { icon: 'âš”ï¸', label: 'Personajes', desc: 'Ver tus personajes', url: '/app', group: 'Navegar' },
    { icon: 'ðŸ“–', label: 'CampaÃ±as', desc: 'Gestionar partidas', url: '/app/campaigns', group: 'Navegar' },
    { icon: 'ðŸ“š', label: 'Compendio', desc: 'Referencia SRD', url: '/app/compendium', group: 'Navegar' },
    { icon: 'âš™ï¸', label: 'Ajustes', desc: 'ConfiguraciÃ³n', url: '/app/settings', group: 'Navegar' },
    { icon: 'ðŸ‘¤', label: 'Mi cuenta', desc: 'Perfil y sesiÃ³n', url: '/app/account', group: 'Navegar' },
    { icon: 'âž•', label: 'Nuevo personaje', desc: 'Crear un personaje', url: '/app/characters/create', group: 'Acciones' },
    { icon: 'ðŸŒ', label: 'Compendio pÃºblico', desc: 'Abrir en nueva pestaÃ±a', url: '/compendio', group: 'Acciones' },
  ];

  const palette = document.getElementById('cmd-palette');
  const cmdInput = document.getElementById('cmd-input') as HTMLInputElement;
  const cmdResults = document.getElementById('cmd-results');
  const cmdBackdrop = document.getElementById('cmd-palette-backdrop');
  let focusIdx = -1;

  function openPalette() {
    palette?.classList.remove('hidden');
    cmdInput?.focus();
    cmdInput.value = '';
    renderResults('');
    document.body.style.overflow = 'hidden';
  }
  function closePalette() {
    palette?.classList.add('hidden');
    document.body.style.overflow = '';
    focusIdx = -1;
  }
  function renderResults(query: string) {
    if (!cmdResults) return;
    const q = query.toLowerCase().trim();
    const filtered = q ? CMD_ITEMS.filter(i => i.label.toLowerCase().includes(q) || i.desc.toLowerCase().includes(q)) : CMD_ITEMS;

    if (filtered.length === 0) {
      cmdResults.innerHTML = '<div class="text-center py-8"><span class="text-[13px] app-text-faint">Sin resultados</span></div>';
      return;
    }
    let html = '';
    let lastGroup = '';
    filtered.forEach((item, i) => {
      if (item.group !== lastGroup) {
        html += `<div class="cmd-group-label">${item.group}</div>`;
        lastGroup = item.group;
      }
      html += `<a href="${item.url}" class="cmd-item" data-idx="${i}"${item.url === '/compendio' ? ' target="_blank"' : ''}>
        <span class="cmd-item-icon">${item.icon}</span>
        <div><div class="cmd-item-label">${item.label}</div><div class="cmd-item-desc">${item.desc}</div></div>
      </a>`;
    });
    cmdResults.innerHTML = html;
    focusIdx = -1;
  }

  // Event listeners
  document.getElementById('sidebar-search-btn')?.addEventListener('click', openPalette);
  document.getElementById('mobile-search-btn')?.addEventListener('click', openPalette);
  cmdBackdrop?.addEventListener('click', closePalette);
  cmdInput?.addEventListener('input', () => renderResults(cmdInput.value));

  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); openPalette(); }
    if (e.key === 'Escape') closePalette();
    // Arrow navigation in palette
    if (!palette?.classList.contains('hidden')) {
      const items = cmdResults?.querySelectorAll('.cmd-item') ?? [];
      if (e.key === 'ArrowDown') { e.preventDefault(); focusIdx = Math.min(focusIdx + 1, items.length - 1); items.forEach((el, i) => el.classList.toggle('focused', i === focusIdx)); }
      if (e.key === 'ArrowUp') { e.preventDefault(); focusIdx = Math.max(focusIdx - 1, 0); items.forEach((el, i) => el.classList.toggle('focused', i === focusIdx)); }
      if (e.key === 'Enter' && focusIdx >= 0) { (items[focusIdx] as HTMLAnchorElement)?.click(); }
    }
  });
</script>
