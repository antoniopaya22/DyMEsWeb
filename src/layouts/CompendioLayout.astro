---
import Layout from './Layout.astro';
import { RACES } from '../data/races';
import { CLASSES } from '../data/classes';
import { BACKGROUNDS } from '../data/backgrounds';
import { CANTRIPS, type Spell } from '../data/cantrips';
import { ALL_SPELLS, SPELLS_LEVEL_1, SPELLS_LEVEL_2, SPELLS_LEVEL_3, SPELLS_LEVEL_4, SPELLS_LEVEL_5, SPELLS_LEVEL_6, SPELLS_LEVEL_7, SPELLS_LEVEL_8, SPELLS_LEVEL_9 } from '../data/spells';
import { CONDITIONS, DAMAGE_TYPES } from '../data/rules';

interface Props {
  title: string;
  section: 'intro' | 'razas' | 'clases' | 'trasfondos' | 'conjuros' | 'reglas';
  breadcrumb?: string;
  parentBreadcrumb?: string;
  parentHref?: string;
}

const { title, section, breadcrumb, parentBreadcrumb, parentHref } = Astro.props;

const TOTAL_SPELLS = CANTRIPS.length + ALL_SPELLS.length;

const SPELL_LEVELS = [
  { nivel: 0, nombre: 'Trucos', count: CANTRIPS.length },
  { nivel: 1, nombre: 'Nivel 1', count: SPELLS_LEVEL_1.length },
  { nivel: 2, nombre: 'Nivel 2', count: SPELLS_LEVEL_2.length },
  { nivel: 3, nombre: 'Nivel 3', count: SPELLS_LEVEL_3.length },
  { nivel: 4, nombre: 'Nivel 4', count: SPELLS_LEVEL_4.length },
  { nivel: 5, nombre: 'Nivel 5', count: SPELLS_LEVEL_5.length },
  { nivel: 6, nombre: 'Nivel 6', count: SPELLS_LEVEL_6.length },
  { nivel: 7, nombre: 'Nivel 7', count: SPELLS_LEVEL_7.length },
  { nivel: 8, nombre: 'Nivel 8', count: SPELLS_LEVEL_8.length },
  { nivel: 9, nombre: 'Nivel 9', count: SPELLS_LEVEL_9.length },
];

// Build search data — now linking to individual pages
const searchData = [
  ...RACES.map(r => ({ nombre: r.nombre, icon: r.icon, category: 'Raza', url: `/compendio/razas/${r.id}` })),
  ...CLASSES.map(c => ({ nombre: c.nombre, icon: c.icon, category: 'Clase', url: `/compendio/clases/${c.id}` })),
  ...BACKGROUNDS.map(b => ({ nombre: b.nombre, icon: b.icon, category: 'Trasfondo', url: `/compendio/trasfondos/${b.id}` })),
  ...CANTRIPS.map(s => ({ nombre: s.nombre, icon: 'fa-solid fa-wand-sparkles', category: 'Truco', url: `/compendio/conjuros#spell-${s.id}` })),
  ...ALL_SPELLS.map(s => ({ nombre: s.nombre, icon: 'fa-solid fa-wand-sparkles', category: 'Conjuro', url: `/compendio/conjuros#spell-${s.id}` })),
  ...CONDITIONS.map(c => ({ nombre: c.nombre, icon: c.icon, category: 'Condición', url: `/compendio/reglas#cond-${c.id}` })),
  ...DAMAGE_TYPES.map(d => ({ nombre: d.nombre, icon: d.icon, category: 'Tipo de daño', url: `/compendio/reglas#tipos-dano` })),
  { nombre: 'Combate', icon: 'fa-solid fa-shield-halved', category: 'Reglas', url: '/compendio/reglas#combate' },
  { nombre: 'Descansos', icon: 'fa-solid fa-bed', category: 'Reglas', url: '/compendio/reglas#descansos' },
  { nombre: 'Pruebas de Característica', icon: 'fa-solid fa-crosshairs', category: 'Reglas', url: '/compendio/reglas#pruebas' },
  { nombre: 'Puntuaciones de Característica', icon: 'fa-solid fa-dice-d20', category: 'Reglas', url: '/compendio/reglas#caracteristicas' },
];

// Determine current page path for active nav highlighting
const currentPath = Astro.url.pathname.replace(/\/$/, '');
---

<Layout title={title} description="Consulta el compendio del System Reference Document 5.1 de D&D 5e en español.">

  <!-- ─── Top Header Bar ─── -->
  <header class="docs-header">
    <div class="docs-header-inner">
      <button id="sidebar-toggle" class="docs-header-burger lg:hidden" type="button" aria-label="Abrir menú">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
      <a href="/" class="docs-logo">
        <img src="/favicon.svg" alt="" class="w-6 h-6" />
        <span class="font-display font-bold text-[14px] text-[#272519]">DyMEs</span>
      </a>

      <button id="search-trigger" class="docs-search-trigger" type="button">
        <svg class="w-4 h-4 text-[#978F62]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <span class="text-[13px] text-[#978F62]">Buscar en el compendio...</span>
        <kbd class="docs-kbd">Ctrl K</kbd>
      </button>

      <div class="flex items-center gap-3">
        <a href="/" class="text-[13px] text-[#555137] hover:text-[#272519] transition-colors hidden sm:inline">Inicio</a>
        <a href="/login" class="text-[13px] font-semibold bg-[#8f3d38] hover:bg-[#a04540] text-white px-4 py-1.5 rounded-lg transition-all hover:shadow-lg hover:shadow-[#8f3d38]/20">Empezar</a>
      </div>
    </div>
  </header>



  <!-- ─── Backdrop ─── -->
  <div id="sidebar-backdrop" class="docs-backdrop hidden lg:hidden"></div>

  <!-- ─── Layout shell ─── -->
  <div class="docs-shell">

    <!-- ═══ LEFT SIDEBAR ═══ -->
    <aside id="sidebar" class="docs-sidebar">
      <div class="docs-sidebar-inner">

        <!-- Sidebar header -->
        <div class="docs-sidebar-header">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-book-open text-sm text-[#8f3d38]"></i>
            <div>
              <div class="text-[13px] font-display font-bold text-[#272519]">Compendio SRD</div>
              <div class="text-[10px] text-[#978F62] tracking-wide">D&D 5e · Español</div>
            </div>
          </div>
        </div>

        <!-- Nav sections -->
        <nav class="docs-nav">

          <!-- Intro -->
          <a href="/compendio" class={`docs-nav-link ${section === 'intro' ? 'docs-nav-link-active' : ''}`}>
            <svg class="w-4 h-4 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
            Introducción
          </a>

          <!-- Razas -->
          <div class="docs-nav-group">
            <button class="docs-nav-group-btn" data-section="razas" data-active={section === 'razas' ? 'true' : 'false'} type="button">
              <span class="flex items-center gap-2">
                <i class="fa-solid fa-users text-sm"></i>
                <span>Razas</span>
              </span>
              <span class="flex items-center gap-1.5">
                <span class="docs-nav-badge">{RACES.length}</span>
                <svg class="docs-nav-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
              </span>
            </button>
            <div class="docs-nav-group-items" data-group="razas">
              {RACES.map(r => (
                <a href={`/compendio/razas/${r.id}`} class={`docs-nav-item ${currentPath === `/compendio/razas/${r.id}` ? 'active' : ''}`} data-nav={r.id}>
                  <span class="docs-nav-dot"></span>
                  {r.nombre}
                </a>
              ))}
            </div>
          </div>

          <!-- Clases -->
          <div class="docs-nav-group">
            <button class="docs-nav-group-btn" data-section="clases" data-active={section === 'clases' ? 'true' : 'false'} type="button">
              <span class="flex items-center gap-2">
                <i class="fa-solid fa-shield-halved text-sm"></i>
                <span>Clases</span>
              </span>
              <span class="flex items-center gap-1.5">
                <span class="docs-nav-badge">{CLASSES.length}</span>
                <svg class="docs-nav-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
              </span>
            </button>
            <div class="docs-nav-group-items" data-group="clases">
              {CLASSES.map(c => (
                <a href={`/compendio/clases/${c.id}`} class={`docs-nav-item ${currentPath === `/compendio/clases/${c.id}` ? 'active' : ''}`} data-nav={c.id}>
                  <span class="docs-nav-dot"></span>
                  {c.nombre}
                </a>
              ))}
            </div>
          </div>

          <!-- Trasfondos -->
          <div class="docs-nav-group">
            <button class="docs-nav-group-btn" data-section="trasfondos" data-active={section === 'trasfondos' ? 'true' : 'false'} type="button">
              <span class="flex items-center gap-2">
                <i class="fa-solid fa-scroll text-sm"></i>
                <span>Trasfondos</span>
              </span>
              <span class="flex items-center gap-1.5">
                <span class="docs-nav-badge">{BACKGROUNDS.length}</span>
                <svg class="docs-nav-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
              </span>
            </button>
            <div class="docs-nav-group-items" data-group="trasfondos">
              {BACKGROUNDS.map(b => (
                <a href={`/compendio/trasfondos/${b.id}`} class={`docs-nav-item ${currentPath === `/compendio/trasfondos/${b.id}` ? 'active' : ''}`} data-nav={b.id}>
                  <span class="docs-nav-dot"></span>
                  {b.nombre}
                </a>
              ))}
            </div>
          </div>

          <!-- Conjuros -->
          <div class="docs-nav-group">
            <button class="docs-nav-group-btn" data-section="conjuros" data-active={section === 'conjuros' ? 'true' : 'false'} type="button">
              <span class="flex items-center gap-2">
                <i class="fa-solid fa-wand-sparkles text-sm"></i>
                <span>Conjuros</span>
              </span>
              <span class="flex items-center gap-1.5">
                <span class="docs-nav-badge">{TOTAL_SPELLS}</span>
                <svg class="docs-nav-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
              </span>
            </button>
            <div class="docs-nav-group-items" data-group="conjuros">
              {SPELL_LEVELS.map(sl => (
                <a href={`/compendio/conjuros#conjuros-nivel-${sl.nivel}`} class="docs-nav-item" data-nav={`conjuros-nivel-${sl.nivel}`}>
                  <span class="docs-nav-dot"></span>
                  {sl.nombre} ({sl.count})
                </a>
              ))}
            </div>
          </div>

          <!-- Reglas -->
          <div class="docs-nav-group">
            <button class="docs-nav-group-btn" data-section="reglas" data-active={section === 'reglas' ? 'true' : 'false'} type="button">
              <span class="flex items-center gap-2">
                <i class="fa-solid fa-scale-balanced text-sm"></i>
                <span>Reglas</span>
              </span>
              <span class="flex items-center gap-1.5">
                <svg class="docs-nav-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
              </span>
            </button>
            <div class="docs-nav-group-items" data-group="reglas">
              <a href="/compendio/reglas#caracteristicas" class="docs-nav-item" data-nav="caracteristicas">
                <span class="docs-nav-dot"></span>
                Características
              </a>
              <a href="/compendio/reglas#pruebas" class="docs-nav-item" data-nav="pruebas">
                <span class="docs-nav-dot"></span>
                Pruebas
              </a>
              <a href="/compendio/reglas#combate" class="docs-nav-item" data-nav="combate">
                <span class="docs-nav-dot"></span>
                Combate
              </a>
              <a href="/compendio/reglas#condiciones" class="docs-nav-item" data-nav="condiciones">
                <span class="docs-nav-dot"></span>
                Condiciones
              </a>
              <a href="/compendio/reglas#descansos" class="docs-nav-item" data-nav="descansos">
                <span class="docs-nav-dot"></span>
                Descansos
              </a>
              <a href="/compendio/reglas#tipos-dano" class="docs-nav-item" data-nav="tipos-dano">
                <span class="docs-nav-dot"></span>
                Tipos de daño
              </a>
            </div>
          </div>

        </nav>

        <!-- Sidebar footer -->
        <div class="docs-sidebar-footer">
          <p class="text-[10px] text-[#978F62] leading-relaxed">SRD 5.1 · OGL 1.0a</p>
        </div>
      </div>
    </aside>

    <!-- ═══ MAIN CONTENT ═══ -->
    <main class="docs-main">
      <div class="docs-content">

        <!-- Breadcrumbs -->
        <div class="docs-breadcrumbs">
          <a href="/">DyMEs</a>
          <svg class="w-3 h-3 text-[#978F62]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
          {parentBreadcrumb ? (
            <>
              <a href="/compendio">Compendio</a>
              <svg class="w-3 h-3 text-[#978F62]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
              <a href={parentHref}>{parentBreadcrumb}</a>
              <svg class="w-3 h-3 text-[#978F62]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
              <span class="text-[#272519]">{breadcrumb}</span>
            </>
          ) : breadcrumb ? (
            <>
              <a href="/compendio">Compendio</a>
              <svg class="w-3 h-3 text-[#978F62]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
              <span class="text-[#272519]">{breadcrumb}</span>
            </>
          ) : (
            <span class="text-[#272519]">Compendio</span>
          )}
        </div>

        <slot />

        <!-- Footer attribution -->
        <footer class="docs-footer">
          <p>Contenido basado en el System Reference Document 5.1 (SRD 5.1) de Wizards of the Coast, disponible bajo la Open Gaming License (OGL 1.0a).</p>
          <p class="mt-2">No afiliado con Wizards of the Coast.</p>
        </footer>

      </div>
    </main>
  </div>

  <!-- ═══ SEARCH MODAL (Ctrl+K) ═══ -->
  <div id="search-modal" class="docs-search-modal hidden">
    <div class="docs-search-backdrop"></div>
    <div class="docs-search-dialog">
      <div class="docs-search-input-wrap">
        <svg class="w-5 h-5 text-[#978F62] shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <input id="search-input" type="text" placeholder="Buscar razas, clases, trasfondos, conjuros..." class="docs-search-input" autocomplete="off" />
        <kbd class="docs-kbd text-[10px]">Esc</kbd>
      </div>
      <div id="search-results" class="docs-search-results">
        <div class="docs-search-empty">
          <i class="fa-solid fa-magnifying-glass text-2xl mb-2 text-[#978F62]"></i>
          <span class="text-[13px] text-[#978F62]">Escribe para buscar en el compendio</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Search data injected from server -->
  <script id="search-data" type="application/json" set:html={JSON.stringify(searchData)} />

  <!-- ═══ STYLES ═══ -->
  <style is:global>
    /* ─── Header ─── */
    .docs-header {
      position: sticky; top: 0; z-index: 40;
      background: rgba(240, 239, 232, 0.92);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(212, 209, 189, 0.35);
      height: 56px;
    }
    .docs-header-inner {
      max-width: 1400px; margin: 0 auto;
      display: flex; align-items: center; justify-content: space-between;
      height: 100%; padding: 0 1.5rem;
      gap: 1rem;
    }
    .docs-logo {
      display: flex; align-items: center; gap: 0.5rem;
      text-decoration: none; flex-shrink: 0;
    }
    .docs-logo:hover img { transform: scale(1.1); }
    .docs-logo img { transition: transform 0.2s; }

    .docs-search-trigger {
      display: flex; align-items: center; gap: 0.6rem;
      background: white; border: 1px solid rgba(212, 209, 189, 0.4);
      border-radius: 10px; padding: 0.45rem 0.9rem;
      cursor: pointer; transition: all 0.2s;
      max-width: 400px; width: 100%; flex: 1;
    }
    .docs-search-trigger:hover { border-color: rgba(143, 61, 56, 0.3); box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
    .docs-kbd {
      font-family: Inter, system-ui, sans-serif; font-size: 11px; font-weight: 500;
      background: #f5f4ef; border: 1px solid rgba(212, 209, 189, 0.5);
      border-radius: 5px; padding: 1px 6px; color: #978F62;
      margin-left: auto; flex-shrink: 0;
    }

    /* ─── Mobile header burger ─── */
    .docs-header-burger {
      display: none; align-items: center; justify-content: center;
      background: none; border: none; cursor: pointer;
      color: #555137; padding: 0.35rem; border-radius: 8px;
      transition: all 0.15s; flex-shrink: 0;
    }
    .docs-header-burger:hover { color: #272519; background: rgba(39,37,25,0.06); }
    @media (max-width: 1023px) {
      .docs-header-burger { display: flex; }
    }

    .docs-backdrop {
      position: fixed; inset: 0; z-index: 35;
      background: rgba(0,0,0,0.3); backdrop-filter: blur(2px);
    }

    /* ─── Layout shell ─── */
    .docs-shell {
      display: flex; min-height: calc(100vh - 56px);
      max-width: 1400px; margin: 0 auto;
    }

    /* ─── Sidebar ─── */
    .docs-sidebar {
      width: 260px; flex-shrink: 0;
      border-right: 1px solid rgba(212, 209, 189, 0.3);
      position: sticky; top: 56px;
      height: calc(100vh - 56px);
      overflow: hidden;
      background: #F0EFE8;
    }
    .docs-sidebar-inner {
      height: 100%; overflow-y: auto; overflow-x: hidden;
      display: flex; flex-direction: column;
      padding: 0;
      scrollbar-width: thin;
      scrollbar-color: rgba(212,209,189,0.5) transparent;
    }
    .docs-sidebar-inner::-webkit-scrollbar { width: 4px; }
    .docs-sidebar-inner::-webkit-scrollbar-thumb { background: rgba(212,209,189,0.5); border-radius: 4px; }
    .docs-sidebar-header { padding: 1.25rem 1.25rem 1rem; border-bottom: 1px solid rgba(212,209,189,0.25); }

    .docs-nav { flex: 1; padding: 0.75rem 0.75rem; }
    .docs-nav-link {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.5rem 0.65rem; border-radius: 8px;
      font-size: 13px; color: #555137; text-decoration: none;
      transition: all 0.15s; margin-bottom: 2px;
    }
    .docs-nav-link:hover { color: #272519; background: rgba(39,37,25,0.04); }
    .docs-nav-link-active { color: #8f3d38; background: rgba(143,61,56,0.06); font-weight: 600; }

    .docs-nav-group { margin-top: 0.5rem; }
    .docs-nav-group-btn {
      display: flex; align-items: center; justify-content: space-between; width: 100%;
      background: none; border: none; cursor: pointer;
      padding: 0.5rem 0.65rem; border-radius: 8px;
      font-size: 13px; font-weight: 600; color: #272519;
      transition: all 0.15s; text-align: left;
    }
    .docs-nav-group-btn:hover { background: rgba(39,37,25,0.04); }
    .docs-nav-group-btn[data-active="true"] { color: #8f3d38; background: rgba(143,61,56,0.06); }
    .docs-nav-badge {
      font-size: 10px; font-weight: 600; color: #978F62;
      background: rgba(212,209,189,0.3); border-radius: 6px;
      padding: 1px 6px; min-width: 20px; text-align: center;
    }
    .docs-nav-chevron {
      width: 14px; height: 14px; color: #978F62;
      transition: transform 0.2s;
    }
    .docs-nav-group-btn[aria-expanded="true"] .docs-nav-chevron { transform: rotate(180deg); }

    .docs-nav-group-items {
      overflow: hidden; max-height: 0;
      transition: max-height 0.25s ease;
      padding-left: 0.5rem;
    }
    .docs-nav-group-items.open { max-height: 800px; }
    .docs-nav-item {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.35rem 0.65rem; border-radius: 6px;
      font-size: 12.5px; color: #555137; text-decoration: none;
      transition: all 0.15s; margin: 1px 0;
      border-left: 2px solid transparent; margin-left: 0.25rem;
    }
    .docs-nav-item:hover { color: #272519; background: rgba(39,37,25,0.03); }
    .docs-nav-item.active { color: #8f3d38; border-left-color: #8f3d38; font-weight: 500; background: rgba(143,61,56,0.04); }
    .docs-nav-dot {
      width: 4px; height: 4px; border-radius: 50%;
      background: rgba(151,143,98,0.4); flex-shrink: 0;
    }
    .docs-nav-item.active .docs-nav-dot { background: #8f3d38; }

    .docs-sidebar-footer { padding: 1rem 1.25rem; border-top: 1px solid rgba(212,209,189,0.25); margin-top: auto; }

    /* ─── Main content ─── */
    .docs-main {
      flex: 1; min-width: 0;
      padding: 2rem 2.5rem 4rem;
    }
    .docs-content { max-width: 840px; }

    .docs-breadcrumbs {
      display: flex; align-items: center; gap: 0.4rem;
      font-size: 12px; color: #978F62; margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    .docs-breadcrumbs a { color: #978F62; text-decoration: none; }
    .docs-breadcrumbs a:hover { color: #8f3d38; }

    /* ─── Typography ─── */
    .docs-h1 {
      font-family: 'Cinzel', serif; font-weight: 700;
      font-size: clamp(1.75rem, 4vw, 2.25rem); line-height: 1.2;
      color: #272519; margin-bottom: 0.75rem;
    }
    .docs-lead { font-size: 16px; color: #555137; line-height: 1.7; max-width: 640px; }
    .docs-h2 {
      font-family: 'Cinzel', serif; font-weight: 700;
      font-size: 1.5rem; color: #272519; margin-bottom: 0.5rem;
    }
    .docs-h3 {
      font-family: 'Cinzel', serif; font-weight: 700;
      font-size: 1.125rem; color: #272519;
    }
    .docs-h4 {
      font-family: 'Cinzel', serif; font-weight: 700;
      font-size: 0.9rem; color: #8f3d38; margin-bottom: 0.5rem;
    }
    .docs-p { font-size: 14px; color: #555137; line-height: 1.75; margin-top: 0.5rem; }

    /* ─── Callout ─── */
    .docs-callout {
      display: flex; gap: 0.85rem; padding: 1rem 1.15rem;
      background: white; border: 1px solid rgba(212,209,189,0.4);
      border-radius: 12px; margin-top: 1.5rem;
      border-left: 3px solid #8f3d38;
    }
    .docs-callout-icon { font-size: 1.25rem; flex-shrink: 0; margin-top: 1px; }

    /* ─── Summary cards (intro page) ─── */
    .docs-summary-card {
      display: flex; flex-direction: column; align-items: center;
      padding: 1.25rem 1rem; border-radius: 12px;
      border: 1px solid rgba(212,209,189,0.3);
      background: white; text-decoration: none;
      transition: all 0.2s;
    }
    .docs-summary-card:hover {
      border-color: rgba(143,61,56,0.25);
      box-shadow: 0 2px 12px rgba(143,61,56,0.08);
      transform: translateY(-1px);
    }

    /* ─── Item cards (index listing pages) ─── */
    .docs-item-card {
      display: flex; flex-direction: column;
      padding: 1.25rem; border-radius: 12px;
      border: 1px solid rgba(212,209,189,0.3);
      background: white; text-decoration: none;
      transition: all 0.2s; position: relative;
      overflow: hidden;
    }
    .docs-item-card:hover {
      border-color: rgba(143,61,56,0.3);
      box-shadow: 0 4px 20px rgba(143,61,56,0.1);
      transform: translateY(-2px);
    }
    .docs-item-card-icon {
      font-size: 2rem; margin-bottom: 0.75rem;
    }
    .docs-item-card-body { flex: 1; }
    .docs-item-card-title {
      font-family: 'Cinzel', serif; font-weight: 700;
      font-size: 1rem; color: #272519; margin-bottom: 0.35rem;
      transition: color 0.15s;
    }
    .docs-item-card:hover .docs-item-card-title { color: #8f3d38; }
    .docs-item-card-desc {
      font-size: 12.5px; color: #555137; line-height: 1.6;
      display: -webkit-box; -webkit-line-clamp: 3;
      -webkit-box-orient: vertical; overflow: hidden;
    }
    .docs-item-card-meta {
      display: flex; flex-wrap: wrap; gap: 0.35rem;
      margin-top: 0.75rem;
    }
    .docs-item-card-tag {
      font-size: 10px; font-weight: 500; color: #978F62;
      background: rgba(212,209,189,0.2); border-radius: 4px;
      padding: 2px 8px; white-space: nowrap;
    }
    .docs-item-card-arrow {
      position: absolute; top: 1rem; right: 1rem;
      font-size: 16px; color: rgba(151,143,98,0.3);
      font-weight: 600; transition: all 0.2s;
    }
    .docs-item-card:hover .docs-item-card-arrow {
      color: #8f3d38; transform: translateX(2px);
    }

    /* ─── Detail page header ─── */
    .docs-detail-page { }
    .docs-detail-header {
      display: flex; align-items: flex-start; gap: 1rem;
      margin-bottom: 1rem;
    }
    .docs-detail-icon { font-size: 2.5rem; flex-shrink: 0; margin-top: 4px; }

    /* ─── Section ─── */
    .docs-section { margin-bottom: 0; }
    .docs-section-header { margin-bottom: 2rem; }
    .docs-section-badge {
      font-size: 12px; font-weight: 600; color: #8f3d38;
      background: rgba(143,61,56,0.06); border-radius: 6px;
      padding: 3px 10px; display: inline-block; margin-bottom: 0.75rem;
    }
    .docs-divider {
      height: 1px; background: rgba(212,209,189,0.35);
      margin: 3rem 0;
    }

    /* ─── Entry ─── */
    .docs-entry { padding: 0; }
    .docs-entry-header {
      display: flex; align-items: flex-start; gap: 0.85rem; margin-bottom: 0.5rem;
      position: relative;
    }
    .docs-entry-icon { font-size: 1.75rem; flex-shrink: 0; margin-top: 2px; }
    .docs-tag {
      font-size: 10px; font-weight: 600; color: #978F62;
      background: rgba(212,209,189,0.25); border-radius: 4px;
      padding: 1px 7px; margin-top: 4px; display: inline-block;
      text-transform: uppercase; letter-spacing: 0.06em;
    }
    .docs-anchor {
      position: absolute; right: 0; top: 0;
      font-size: 18px; color: rgba(151,143,98,0.3);
      text-decoration: none; font-weight: 600;
      opacity: 0; transition: opacity 0.15s;
    }
    .docs-entry:hover .docs-anchor { opacity: 1; }
    .docs-anchor:hover { color: #8f3d38; }

    .docs-stats-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 0.5rem; margin-top: 1rem;
    }
    .docs-stat {
      padding: 0.65rem 0.85rem; border-radius: 8px;
      background: white; border: 1px solid rgba(212,209,189,0.25);
    }
    .docs-stat-label { font-size: 11px; font-weight: 600; color: #978F62; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 2px; }
    .docs-stat-value { font-size: 13px; color: #272519; }

    .docs-entry-divider { height: 1px; background: rgba(212,209,189,0.2); margin: 2rem 0; }

    /* ─── Traits ─── */
    .docs-traits {
      margin-top: 1.25rem; padding: 1rem 1.15rem;
      background: white; border: 1px solid rgba(212,209,189,0.3);
      border-radius: 10px; border-left: 3px solid rgba(143,61,56,0.25);
    }
    .docs-trait {
      font-size: 13px; color: #555137; line-height: 1.7;
      margin-bottom: 0.4rem;
    }
    .docs-trait:last-child { margin-bottom: 0; }
    .docs-trait-name { font-weight: 700; color: #272519; }

    /* ─── Subrace / Subclass detail ─── */
    .docs-subrace {
      margin-top: 0.85rem; padding: 0.85rem 1.15rem;
      background: rgba(143,61,56,0.03); border: 1px solid rgba(143,61,56,0.12);
      border-radius: 10px;
    }
    .docs-subrace .docs-h4 { color: #8f3d38; margin-bottom: 0.35rem; }

    /* ─── Progression Table ─── */
    .docs-progression { }
    .docs-table-wrapper {
      overflow-x: auto; margin-top: 0.75rem;
      border: 1px solid rgba(212,209,189,0.3);
      border-radius: 10px; background: white;
    }
    .docs-table {
      width: 100%; border-collapse: collapse;
      font-size: 12.5px;
    }
    .docs-table thead {
      background: rgba(212,209,189,0.15);
      border-bottom: 1px solid rgba(212,209,189,0.3);
    }
    .docs-table th {
      padding: 0.6rem 0.75rem; text-align: left;
      font-weight: 600; color: #555137;
      text-transform: uppercase; letter-spacing: 0.04em;
      font-size: 10px; white-space: nowrap;
    }
    .docs-table td {
      padding: 0.5rem 0.75rem; color: #272519;
      border-bottom: 1px solid rgba(212,209,189,0.15);
    }
    .docs-table tbody tr:last-child td { border-bottom: none; }
    .docs-table tbody tr:hover { background: rgba(143,61,56,0.02); }
    .docs-table-level {
      font-weight: 700; color: #8f3d38; text-align: center;
      width: 40px;
    }
    .docs-table-prof {
      font-weight: 600; color: #555137; text-align: center;
      width: 45px;
    }
    .docs-table-extra {
      color: #555137; white-space: nowrap; width: 140px;
    }
    .docs-table-features {
      color: #272519; line-height: 1.5;
    }
    .docs-table-empty-row td { color: #978F62; }

    /* ─── Subclass option cards ─── */
    .docs-subclasses { }
    .docs-subclass-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 0.75rem; margin-top: 0.75rem;
    }
    .docs-subclass-card {
      padding: 1rem; border-radius: 10px;
      background: white; border: 1px solid rgba(212,209,189,0.3);
      transition: all 0.15s;
    }
    .docs-subclass-card:hover {
      border-color: rgba(143,61,56,0.2);
      box-shadow: 0 2px 8px rgba(143,61,56,0.06);
    }
    .docs-subclass-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 0.4rem; gap: 0.5rem;
    }
    .docs-subclass-name {
      font-family: 'Cinzel', serif; font-weight: 700;
      font-size: 13px; color: #272519;
    }
    .docs-subclass-source {
      font-size: 9px; font-weight: 600; color: #978F62;
      background: rgba(212,209,189,0.25); border-radius: 3px;
      padding: 1px 6px; text-transform: uppercase;
      letter-spacing: 0.04em; white-space: nowrap; flex-shrink: 0;
    }
    .docs-subclass-desc {
      font-size: 12.5px; color: #555137; line-height: 1.6;
    }

    /* ─── Prev/Next Navigation ─── */
    .docs-prev-next {
      display: flex; justify-content: space-between; gap: 1rem;
      margin-top: 3rem; padding-top: 2rem;
      border-top: 1px solid rgba(212,209,189,0.3);
    }
    .docs-prev-next-link {
      display: flex; flex-direction: column; gap: 0.2rem;
      text-decoration: none; padding: 0.75rem 1rem;
      border-radius: 10px; border: 1px solid rgba(212,209,189,0.3);
      transition: all 0.2s; max-width: 45%;
    }
    .docs-prev-next-link:hover {
      border-color: rgba(143,61,56,0.3);
      box-shadow: 0 2px 8px rgba(143,61,56,0.08);
    }
    .docs-prev-next-right { text-align: right; margin-left: auto; }
    .docs-prev-next-dir {
      font-size: 11px; color: #978F62; font-weight: 500;
    }
    .docs-prev-next-name {
      font-size: 14px; color: #272519; font-weight: 600;
      font-family: 'Cinzel', serif;
    }
    .docs-prev-next-link:hover .docs-prev-next-name { color: #8f3d38; }

    /* ─── Spell level ─── */
    .docs-spell-level { margin-bottom: 1.5rem; }
    .docs-spell-level-title {
      display: flex; align-items: center; gap: 0.5rem;
      margin-bottom: 1rem; padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(212,209,189,0.3);
    }
    .docs-spell-level-icon { font-size: 1.25rem; }
    .ml-2 { margin-left: 0.5rem; }

    /* ─── Spell cards ─── */
    .docs-spell-grid {
      display: grid; grid-template-columns: 1fr;
      gap: 0.4rem;
    }
    .docs-spell-card {
      background: white; border: 1px solid rgba(212,209,189,0.3);
      border-radius: 8px; overflow: hidden;
      transition: border-color 0.15s;
    }
    .docs-spell-card[open] { border-color: rgba(143,61,56,0.25); }
    .docs-spell-card[open] .docs-spell-summary { border-bottom: 1px solid rgba(212,209,189,0.25); }

    .docs-spell-summary {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.55rem 0.85rem; cursor: pointer;
      list-style: none; user-select: none;
      transition: background 0.12s;
    }
    .docs-spell-summary::-webkit-details-marker { display: none; }
    .docs-spell-summary::marker { display: none; content: ''; }
    .docs-spell-summary:hover { background: rgba(143,61,56,0.03); }
    .docs-spell-name { font-size: 13px; font-weight: 600; color: #272519; }
    .docs-spell-school {
      font-size: 11px; color: #978F62; text-transform: uppercase;
      letter-spacing: 0.04em; font-weight: 500;
    }

    .docs-spell-body { padding: 0.75rem 0.85rem; }
    .docs-spell-meta-grid {
      display: grid; grid-template-columns: repeat(2, 1fr);
      gap: 0.35rem; margin-bottom: 0.6rem;
    }
    .docs-spell-meta { display: flex; flex-direction: column; }
    .docs-spell-meta-label {
      font-size: 10px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.04em; color: #978F62;
    }
    .docs-spell-meta-value { font-size: 12.5px; color: #272519; }
    .docs-spell-desc {
      font-size: 13px; color: #555137; line-height: 1.7;
      margin-top: 0.35rem; padding-top: 0.5rem;
      border-top: 1px solid rgba(212,209,189,0.2);
    }

    @media (min-width: 640px) {
      .docs-spell-meta-grid { grid-template-columns: repeat(4, 1fr); }
    }

    /* ─── Footer ─── */
    .docs-footer {
      margin-top: 3rem; padding-top: 2rem;
      border-top: 1px solid rgba(212,209,189,0.3);
      font-size: 12px; color: #978F62; text-align: center;
      line-height: 1.6;
    }

    /* ─── Search Modal ─── */
    .docs-search-modal {
      position: fixed; inset: 0; z-index: 100;
      display: flex; align-items: flex-start; justify-content: center;
      padding-top: min(15vh, 120px);
    }
    .docs-search-modal.hidden { display: none; }
    .docs-search-backdrop {
      position: absolute; inset: 0;
      background: rgba(39,37,25,0.4); backdrop-filter: blur(4px);
    }
    .docs-search-dialog {
      position: relative; width: 90%; max-width: 560px;
      background: white; border-radius: 16px;
      box-shadow: 0 25px 60px rgba(0,0,0,0.18);
      overflow: hidden; border: 1px solid rgba(212,209,189,0.3);
    }
    .docs-search-input-wrap {
      display: flex; align-items: center; gap: 0.7rem;
      padding: 0.85rem 1.15rem;
      border-bottom: 1px solid rgba(212,209,189,0.3);
    }
    .docs-search-input {
      flex: 1; border: none; outline: none; background: none;
      font-size: 15px; color: #272519;
      font-family: 'Crimson Text', serif;
    }
    .docs-search-input::placeholder { color: rgba(151,143,98,0.5); }
    .docs-search-results {
      max-height: 380px; overflow-y: auto; padding: 0.5rem;
      scrollbar-width: thin;
    }
    .docs-search-empty {
      display: flex; flex-direction: column; align-items: center;
      padding: 2.5rem 1rem; gap: 0.25rem;
    }
    .docs-search-result {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.6rem 0.85rem; border-radius: 10px;
      cursor: pointer; text-decoration: none; color: inherit;
      transition: background 0.12s;
    }
    .docs-search-result:hover, .docs-search-result.focused { background: rgba(143,61,56,0.06); }
    .docs-search-result-icon { font-size: 1.25rem; flex-shrink: 0; }
    .docs-search-result-name { font-size: 14px; font-weight: 600; color: #272519; }
    .docs-search-result-cat { font-size: 11px; color: #978F62; margin-top: 1px; }
    .docs-search-no-results {
      padding: 2rem 1rem; text-align: center;
      font-size: 13px; color: #978F62;
    }

    /* ─── Mobile responsive ─── */
    @media (max-width: 1023px) {
      .docs-sidebar {
        position: fixed; left: 0; top: 56px; z-index: 38;
        transform: translateX(-100%);
        transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
        box-shadow: 4px 0 20px rgba(0,0,0,0.1);
        width: 280px;
      }
      .docs-sidebar.open { transform: translateX(0); }
      .docs-main { padding: 1.5rem 1.25rem 3rem; }
    }
    @media (max-width: 640px) {
      .docs-search-trigger span { display: none; }
      .docs-search-trigger { max-width: 44px; padding: 0.45rem 0.6rem; justify-content: center; }
      .docs-search-trigger .docs-kbd { display: none; }
      .docs-stats-grid { grid-template-columns: 1fr; }
      .docs-prev-next { flex-direction: column; }
      .docs-prev-next-link { max-width: 100%; }
      .docs-prev-next-right { text-align: left; margin-left: 0; }
      .docs-subclass-grid { grid-template-columns: 1fr; }
    }
  </style>

  <!-- ═══ SCRIPTS ═══ -->
  <script>
    // Load search data from embedded JSON
    const searchDataEl = document.getElementById('search-data');
    const entries: Array<{nombre: string; icon: string; category: string; url: string}> = searchDataEl ? JSON.parse(searchDataEl.textContent || '[]') : [];

    // ─── Sidebar toggle (mobile) ───
    const sidebar = document.getElementById('sidebar')!;
    const sidebarToggle = document.getElementById('sidebar-toggle')!;
    const backdrop = document.getElementById('sidebar-backdrop')!;

    function toggleSidebar(open?: boolean) {
      const isOpen = open ?? !sidebar.classList.contains('open');
      sidebar.classList.toggle('open', isOpen);
      backdrop.classList.toggle('hidden', !isOpen);
      document.body.style.overflow = isOpen ? 'hidden' : '';
    }
    sidebarToggle.addEventListener('click', () => toggleSidebar());
    backdrop.addEventListener('click', () => toggleSidebar(false));

    // Close sidebar on nav click (mobile)
    sidebar.querySelectorAll('a').forEach(a => {
      a.addEventListener('click', () => {
        if (window.innerWidth < 1024) toggleSidebar(false);
      });
    });

    // ─── Sidebar collapsible groups ───
    document.querySelectorAll('.docs-nav-group-btn').forEach(btn => {
      const group = btn.closest('.docs-nav-group')!;
      const items = group.querySelector('.docs-nav-group-items') as HTMLElement;
      const isActive = (btn as HTMLElement).dataset.active === 'true';

      // Start active section expanded, others collapsed
      if (isActive) {
        items.classList.add('open');
        btn.setAttribute('aria-expanded', 'true');
      } else {
        items.classList.remove('open');
        btn.setAttribute('aria-expanded', 'false');
      }

      btn.addEventListener('click', () => {
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', String(!expanded));
        items.classList.toggle('open', !expanded);
      });
    });

    // ─── Active nav tracking (IntersectionObserver for conjuros page) ───
    const navItems = document.querySelectorAll('[data-nav]');
    const sectionTargets = document.querySelectorAll('[data-section-id]');

    if (sectionTargets.length > 0) {
      const observer = new IntersectionObserver((obs) => {
        obs.forEach(entry => {
          if (entry.isIntersecting) {
            const id = (entry.target as HTMLElement).dataset.sectionId!;
            navItems.forEach(n => {
              const navId = (n as HTMLElement).dataset.nav!;
              // Only toggle for items not already active by URL
              if (!n.classList.contains('active')) {
                n.classList.toggle('active', navId === id);
              }
            });
          }
        });
      }, { rootMargin: '-80px 0px -60% 0px', threshold: 0 });

      sectionTargets.forEach(s => observer.observe(s));
    }

    // ─── Scroll active sidebar item into view ───
    requestAnimationFrame(() => {
      const activeItem = sidebar.querySelector('.docs-nav-item.active');
      if (activeItem) {
        activeItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }
    });

    // ─── Search modal (Ctrl+K) ───
    const modal = document.getElementById('search-modal')!;
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const searchResults = document.getElementById('search-results')!;
    const searchTrigger = document.getElementById('search-trigger')!;
    let focusedIdx = -1;

    function openSearch() {
      modal.classList.remove('hidden');
      searchInput.value = '';
      renderResults('');
      focusedIdx = -1;
      requestAnimationFrame(() => searchInput.focus());
      document.body.style.overflow = 'hidden';
    }
    function closeSearch() {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    searchTrigger.addEventListener('click', openSearch);
    modal.querySelector('.docs-search-backdrop')!.addEventListener('click', closeSearch);

    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); openSearch(); }
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) { closeSearch(); }
    });

    function renderResults(q: string) {
      if (!q.trim()) {
        searchResults.innerHTML = '<div class="docs-search-empty"><i class="fa-solid fa-magnifying-glass text-2xl mb-2 text-[#978F62]"></i><span class="text-[13px] text-[#978F62]">Escribe para buscar en el compendio</span></div>';
        return;
      }
      const lower = q.toLowerCase();
      const matches = entries.filter(e => e.nombre.toLowerCase().includes(lower)).slice(0, 30);
      if (!matches.length) {
        searchResults.innerHTML = '<div class="docs-search-no-results">Sin resultados para "' + q + '"</div>';
        return;
      }
      searchResults.innerHTML = matches.map((m, i) =>
        '<a href="' + m.url + '" class="docs-search-result' + (i === 0 ? ' focused' : '') + '" data-idx="' + i + '">' +
          '<span class="docs-search-result-icon"><i class="' + m.icon + '"></i></span>' +
          '<div>' +
            '<div class="docs-search-result-name">' + m.nombre + '</div>' +
            '<div class="docs-search-result-cat">' + m.category + '</div>' +
          '</div>' +
        '</a>'
      ).join('');
      focusedIdx = 0;
    }

    searchInput.addEventListener('input', () => renderResults(searchInput.value));
    searchInput.addEventListener('keydown', (e) => {
      const items = searchResults.querySelectorAll('.docs-search-result');
      if (!items.length) return;
      if (e.key === 'ArrowDown') { e.preventDefault(); focusedIdx = Math.min(focusedIdx + 1, items.length - 1); }
      if (e.key === 'ArrowUp') { e.preventDefault(); focusedIdx = Math.max(focusedIdx - 1, 0); }
      if (e.key === 'Enter' && focusedIdx >= 0) {
        e.preventDefault();
        const link = items[focusedIdx] as HTMLAnchorElement;
        closeSearch();
        window.location.href = link.href;
      }
      items.forEach((it, i) => it.classList.toggle('focused', i === focusedIdx));
      items[focusedIdx]?.scrollIntoView({ block: 'nearest' });
    });

    // Handle search result clicks
    searchResults.addEventListener('click', (e) => {
      const result = (e.target as HTMLElement).closest('.docs-search-result') as HTMLAnchorElement | null;
      if (result) {
        e.preventDefault();
        closeSearch();
        window.location.href = result.href;
      }
    });
  </script>

</Layout>
